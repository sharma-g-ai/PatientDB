<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthix - Patient Data Chat</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Additional custom styles */
        .chat-message {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        textarea {
            resize: none;
            field-sizing: content;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        const { Upload, Send, Paperclip, X, FileText, Image, Table } = lucideReact;

        const PatientDataChat = () => {
          const [messages, setMessages] = useState([
            {
              id: 1,
              type: 'assistant',
              content: "Welcome to Healthix! ðŸ¥ I'm your intelligent patient data assistant. You can ask me questions about your patient records, upload medical documents, Excel files with patient data, or ask about specific treatments and medications.",
              timestamp: new Date().toLocaleTimeString()
            }
          ]);
          const [inputMessage, setInputMessage] = useState('');
          const [attachedFiles, setAttachedFiles] = useState([]);
          const [isUploading, setIsUploading] = useState(false);
          const [chatSessionId] = useState(() => `chat_${Math.random().toString(36).substr(2, 9)}_${Date.now()}`);
          
          const fileInputRef = useRef(null);
          const messagesEndRef = useRef(null);

          const scrollToBottom = () => {
            messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
          };

          useEffect(scrollToBottom, [messages]);

          const getFileIcon = (fileType) => {
            if (fileType.startsWith('image/')) return React.createElement(Image, { className: "w-4 h-4" });
            if (fileType.includes('sheet') || fileType.includes('csv') || fileType.includes('excel')) return React.createElement(Table, { className: "w-4 h-4" });
            return React.createElement(FileText, { className: "w-4 h-4" });
          };

          const handleFileSelect = async (event) => {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            setIsUploading(true);
            
            try {
              for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('chat_session_id', chatSessionId);

                const response = await fetch('/api/documents/attach-to-chat', {
                  method: 'POST',
                  body: formData
                });

                if (response.ok) {
                  const result = await response.json();
                  setAttachedFiles(prev => [...prev, {
                    id: Date.now() + Math.random(),
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    attachmentType: result.attachment_type
                  }]);

                  // Add a system message about the file attachment
                  setMessages(prev => [...prev, {
                    id: Date.now() + Math.random(),
                    type: 'system',
                    content: `ðŸ“Ž Attached: ${file.name} (${result.attachment_type}) - Content added to chat context`,
                    timestamp: new Date().toLocaleTimeString()
                  }]);
                } else {
                  const errorData = await response.json();
                  throw new Error(errorData.detail || 'Failed to upload file');
                }
              }
            } catch (error) {
              console.error('File upload error:', error);
              setMessages(prev => [...prev, {
                id: Date.now() + Math.random(),
                type: 'system',
                content: `âŒ Failed to attach files: ${error.message}`,
                timestamp: new Date().toLocaleTimeString()
              }]);
            } finally {
              setIsUploading(false);
              event.target.value = '';
            }
          };

          const removeFile = (fileId) => {
            setAttachedFiles(prev => prev.filter(file => file.id !== fileId));
          };

          const sendMessage = async () => {
            if (!inputMessage.trim() || isUploading) return;

            const userMessage = {
              id: Date.now(),
              type: 'user',
              content: inputMessage,
              timestamp: new Date().toLocaleTimeString()
            };

            setMessages(prev => [...prev, userMessage]);
            const messageToSend = inputMessage;
            setInputMessage('');

            try {
              const response = await fetch('/api/chat/message', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  message: messageToSend,
                  chat_session_id: chatSessionId
                })
              });

              if (response.ok) {
                const data = await response.json();
                setMessages(prev => [...prev, {
                  id: Date.now() + Math.random(),
                  type: 'assistant',
                  content: data.message,
                  timestamp: new Date().toLocaleTimeString(),
                  hasContext: data.has_context
                }]);
              } else {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Failed to get response');
              }
            } catch (error) {
              setMessages(prev => [...prev, {
                id: Date.now() + Math.random(),
                type: 'assistant',
                content: 'Sorry, I encountered an error. Please make sure the backend server is running and try again.',
                timestamp: new Date().toLocaleTimeString()
              }]);
            }
          };

          const handleKeyPress = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              sendMessage();
            }
          };

          return React.createElement('div', { className: "flex flex-col h-screen bg-slate-900" },
            // Chat Header
            React.createElement('div', { className: "bg-slate-800 p-4 border-b border-slate-700" },
              React.createElement('div', { className: "flex items-center gap-3" },
                React.createElement('div', { className: "w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center" },
                  React.createElement('span', { className: "text-white font-bold" }, "ðŸ’¬")
                ),
                React.createElement('div', null,
                  React.createElement('h2', { className: "text-white font-semibold" }, "Patient Data Chat"),
                  React.createElement('p', { className: "text-slate-400 text-sm" },
                    attachedFiles.length > 0 
                      ? `${attachedFiles.length} file(s) attached - Context active`
                      : 'Ask questions about your patient records'
                  )
                )
              )
            ),

            // Attached Files Panel
            attachedFiles.length > 0 && React.createElement('div', { className: "bg-slate-800 p-3 border-b border-slate-700" },
              React.createElement('div', { className: "flex flex-wrap gap-2" },
                attachedFiles.map(file => 
                  React.createElement('div', { 
                    key: file.id, 
                    className: "flex items-center gap-2 bg-slate-700 rounded-lg px-3 py-1 text-sm" 
                  },
                    getFileIcon(file.type),
                    React.createElement('span', { className: "text-slate-300" }, file.name),
                    React.createElement('span', { className: "text-green-400 text-xs" }, `(${file.attachmentType})`),
                    React.createElement('button', {
                      onClick: () => removeFile(file.id),
                      className: "text-slate-400 hover:text-red-400 ml-1"
                    }, React.createElement(X, { className: "w-3 h-3" }))
                  )
                )
              )
            ),

            // Messages Area
            React.createElement('div', { className: "flex-1 overflow-y-auto p-4 space-y-4" },
              messages.map(message => 
                React.createElement('div', { 
                  key: message.id, 
                  className: `flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}` 
                },
                  React.createElement('div', { 
                    className: `max-w-[80%] rounded-lg p-3 chat-message ${
                      message.type === 'user' 
                        ? 'bg-green-600 text-white ml-12'
                        : message.type === 'system'
                        ? 'bg-slate-700 text-slate-300 italic'
                        : 'bg-slate-700 text-slate-100 mr-12'
                    }` 
                  },
                    React.createElement('div', { className: "whitespace-pre-wrap" }, message.content),
                    React.createElement('div', { 
                      className: `text-xs mt-1 ${
                        message.type === 'user' ? 'text-green-200' : 'text-slate-400'
                      }` 
                    },
                      message.timestamp,
                      message.hasContext && React.createElement('span', { className: "ml-2 text-green-400" }, "â€¢ Context available")
                    )
                  )
                )
              ),
              React.createElement('div', { ref: messagesEndRef })
            ),

            // Upload Progress
            isUploading && React.createElement('div', { className: "bg-yellow-900 text-yellow-200 p-2 mx-4 rounded text-sm" },
              "Uploading files..."
            ),

            // Input Area
            React.createElement('div', { className: "bg-slate-800 p-4 border-t border-slate-700" },
              React.createElement('div', { className: "flex items-end gap-3" },
                React.createElement('input', {
                  type: "file",
                  ref: fileInputRef,
                  onChange: handleFileSelect,
                  multiple: true,
                  accept: ".pdf,.jpg,.jpeg,.png,.txt,.xlsx,.xls,.csv,.tsv,.json",
                  className: "hidden"
                }),
                
                React.createElement('button', {
                  onClick: () => fileInputRef.current?.click(),
                  disabled: isUploading,
                  className: "flex items-center justify-center w-10 h-10 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 rounded-lg transition-colors",
                  title: "Attach Files"
                }, React.createElement(Paperclip, { className: "w-5 h-5 text-white" })),
                
                React.createElement('div', { className: "flex-1" },
                  React.createElement('textarea', {
                    value: inputMessage,
                    onChange: (e) => setInputMessage(e.target.value),
                    onKeyPress: handleKeyPress,
                    placeholder: "Ask about patient data...",
                    className: "w-full bg-slate-700 text-white rounded-lg px-4 py-2 resize-none focus:outline-none focus:ring-2 focus:ring-green-500",
                    rows: "1",
                    style: { minHeight: '40px', maxHeight: '120px' }
                  })
                ),
                
                React.createElement('button', {
                  onClick: sendMessage,
                  disabled: !inputMessage.trim() || isUploading,
                  className: "flex items-center justify-center w-10 h-10 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 rounded-lg transition-colors",
                  title: "Send Message"
                }, React.createElement(Send, { className: "w-5 h-5 text-white" }))
              )
            )
          );
        };

        const App = () => {
          return React.createElement('div', { className: "h-screen" },
            React.createElement(PatientDataChat)
          );
        };

        ReactDOM.render(React.createElement(App), document.getElementById('root'));
    </script>
</body>
</html>
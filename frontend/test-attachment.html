<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with File Attachment - Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .paperclip-icon {
            width: 20px;
            height: 20px;
            fill: white;
        }
        .send-icon {
            width: 16px;
            height: 16px;
            fill: white;
        }
    </style>
</head>
<body class="bg-slate-900 text-white h-screen flex flex-col">
    <div class="flex-1 flex flex-col max-w-4xl mx-auto w-full">
        <!-- Header -->
        <div class="bg-slate-800 p-4 border-b border-slate-700">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center">
                    <span>üí¨</span>
                </div>
                <div>
                    <h2 class="font-semibold">Patient Data Chat</h2>
                    <p class="text-slate-400 text-sm" id="contextStatus">Click the üìé button to attach files</p>
                </div>
            </div>
        </div>

        <!-- Attached Files Panel (hidden by default) -->
        <div id="filesPanel" class="hidden bg-slate-800 p-3 border-b border-slate-700">
            <div class="text-xs text-slate-400 mb-2">Attached Files:</div>
            <div id="filesList" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- Messages Area -->
        <div class="flex-1 overflow-y-auto p-4">
            <div class="space-y-4">
                <div class="flex justify-start">
                    <div class="bg-slate-700 rounded-lg p-3 max-w-[80%]">
                        <div class="text-sm">Welcome to Healthix! üè• I'm your intelligent patient data assistant. Use the üìé paperclip button below to attach medical documents, Excel files, or other patient data files.</div>
                        <div class="text-xs text-slate-400 mt-1">System ‚Ä¢ Now</div>
                    </div>
                </div>
                <div id="messages" class="space-y-4">
                    <!-- Messages will be added here -->
                </div>
            </div>
        </div>

        <!-- Input Area with VISIBLE Attachment Button -->
        <div class="bg-slate-800 p-4 border-t border-slate-700">
            <div class="flex items-end gap-3">
                <!-- Hidden file input -->
                <input 
                    type="file" 
                    id="fileInput" 
                    multiple 
                    accept=".pdf,.jpg,.jpeg,.png,.txt,.xlsx,.xls,.csv,.tsv,.json"
                    class="hidden"
                >
                
                <!-- ATTACHMENT BUTTON - CLEARLY VISIBLE -->
                <button 
                    id="attachBtn"
                    class="flex items-center justify-center w-12 h-12 bg-green-600 hover:bg-green-700 rounded-lg transition-colors border-2 border-green-400"
                    title="Attach Files"
                >
                    <!-- Paperclip SVG Icon -->
                    <svg class="paperclip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                    </svg>
                </button>
                
                <!-- Message Input -->
                <textarea 
                    id="messageInput"
                    placeholder="Ask about patient data..."
                    class="flex-1 bg-slate-700 text-white rounded-lg px-4 py-3 resize-none focus:outline-none focus:ring-2 focus:ring-green-500"
                    rows="1"
                ></textarea>
                
                <!-- Send Button -->
                <button 
                    id="sendBtn"
                    class="flex items-center justify-center w-12 h-12 bg-green-600 hover:bg-green-700 rounded-lg transition-colors"
                    title="Send Message"
                >
                    <!-- Send SVG Icon -->
                    <svg class="send-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22,2 15,21 11,13 3,9 22,2"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // File attachment functionality
        const fileInput = document.getElementById('fileInput');
        const attachBtn = document.getElementById('attachBtn');
        const filesPanel = document.getElementById('filesPanel');
        const filesList = document.getElementById('filesList');
        const contextStatus = document.getElementById('contextStatus');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const messagesDiv = document.getElementById('messages');

        let attachedFiles = [];
        let chatSessionId = `chat_${Math.random().toString(36).substr(2, 9)}_${Date.now()}`;

        // Attach button click handler
        attachBtn.addEventListener('click', () => {
            fileInput.click();
        });

        // File selection handler
        fileInput.addEventListener('change', async (event) => {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            attachBtn.innerHTML = '‚è≥';
            attachBtn.disabled = true;

            for (const file of files) {
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('chat_session_id', chatSessionId);

                    // Try to upload to backend
                    const response = await fetch('/api/documents/attach-to-chat', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        attachedFiles.push({
                            name: file.name,
                            type: file.type,
                            id: Date.now() + Math.random()
                        });

                        addMessage(`üìé Attached: ${file.name} - Ready for chat!`, 'system');
                    } else {
                        // Even if backend fails, show the file as attached for testing
                        attachedFiles.push({
                            name: file.name,
                            type: file.type,
                            id: Date.now() + Math.random()
                        });
                        addMessage(`üìé ${file.name} attached (backend connection needed for full functionality)`, 'system');
                    }
                } catch (error) {
                    // Show file as attached even on error for testing
                    attachedFiles.push({
                        name: file.name,
                        type: file.type,
                        id: Date.now() + Math.random()
                    });
                    addMessage(`üìé ${file.name} attached locally (backend connection needed)`, 'system');
                }
            }

            updateFilesDisplay();
            attachBtn.innerHTML = '<svg class="paperclip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>';
            attachBtn.disabled = false;
            event.target.value = '';
        });

        function updateFilesDisplay() {
            if (attachedFiles.length > 0) {
                filesPanel.classList.remove('hidden');
                contextStatus.textContent = `${attachedFiles.length} file(s) attached - Context active`;
                
                filesList.innerHTML = attachedFiles.map(file => `
                    <div class="flex items-center gap-2 bg-slate-700 rounded px-3 py-1 text-sm">
                        <span>üìÑ</span>
                        <span>${file.name}</span>
                        <button onclick="removeFile('${file.id}')" class="text-red-400 hover:text-red-300 ml-1">√ó</button>
                    </div>
                `).join('');
            } else {
                filesPanel.classList.add('hidden');
                contextStatus.textContent = 'Click the üìé button to attach files';
            }
        }

        function removeFile(fileId) {
            attachedFiles = attachedFiles.filter(f => f.id.toString() !== fileId);
            updateFilesDisplay();
        }

        function addMessage(content, type = 'assistant') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'}`;
            messageDiv.innerHTML = `
                <div class="bg-${type === 'user' ? 'green-600' : type === 'system' ? 'slate-600' : 'slate-700'} rounded-lg p-3 max-w-[80%] ${type === 'system' ? 'italic text-sm' : ''}">
                    <div class="text-sm">${content}</div>
                    <div class="text-xs opacity-70 mt-1">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Send message functionality
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            messageInput.value = '';

            // Try to send to backend
            try {
                const response = await fetch('/api/chat/message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        chat_session_id: chatSessionId
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    addMessage(data.message);
                } else {
                    throw new Error('Backend not available');
                }
            } catch (error) {
                addMessage("I'm ready to chat! Please start the backend server (python main.py) to enable AI responses.", 'system');
            }
        }

        // Show initial message
        console.log('üîß Chat interface loaded with attachment functionality');
        console.log('üìé Attachment button should be visible next to the input field');
    </script>
</body>
</html>